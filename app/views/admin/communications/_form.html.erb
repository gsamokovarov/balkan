<%# locals: (communication:) %>

<div class="space-y-6">
  <% form_url = communication.new_record? ? admin_event_communications_path : admin_event_communication_path(communication) %>
  <%= admin_form communication, url: form_url do |f| %>
    <!-- Template Selection (only for new records) -->
    <% if communication.new_record? %>
      <%= f.select_input :communication_template_id,
          CommunicationTemplate.all.map { [it.name, it.id] },
          { include_blank: "Start from scratch", label: "Template (optional)" },
          { data: { action: "change->communication-composer#loadTemplate" } } %>

      <p class="text-sm text-gray-500 dark:text-gray-400 -mt-4">
        Select a template to pre-fill the subject and content
      </p>
    <% end %>

    <!-- Subject -->
    <%= f.text_input :subject, required: true,
        placeholder: "e.g., Get ready for {{ event_name }}!" %>

    <!-- Content (Liquid) -->
    <%= f.text_area_input :content, required: true, rows: 15,
        placeholder: "Use Liquid variables: {{ email }}, {{ event_name }}, {{ year }}, etc." %>

    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm">
      <p class="font-medium mb-2">Available Liquid Variables:</p>
      <div class="grid grid-cols-2 gap-2 text-gray-600 dark:text-gray-400">
        <code>{{ email }}</code>
        <code>{{ event_name }}</code>
        <code>{{ event_start_date }}</code>
        <code>{{ event_end_date }}</code>
        <code>{{ year }}</code>
      </div>
    </div>

    <hr class="border-gray-200 dark:border-gray-700">

    <!-- Recipient Selection -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Recipients</h3>

      <%= f.check_box_input :include_subscribers, label: "Newsletter Subscribers" %>
      <%= f.check_box_input :include_ticket_holders, label: "Ticket Holders" %>
      <%= f.check_box_input :include_speakers, label: "Confirmed Speakers" %>

      <div>
        <%= label_tag "communication_event_ids", "Events", class: "block text-sm font-medium text-gray-700 dark:text-gray-300" %>
        <%= select_tag "communication[event_ids][]",
            options_from_collection_for_select(Event.all.order(start_date: :desc), :id, :name, communication.event_ids || [params[:event_id]]),
            { multiple: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100", size: 5 } %>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          Hold Cmd/Ctrl to select multiple events
        </p>
      </div>

      <%= f.text_area_input :custom_recipients_text, rows: 4,
          placeholder: "additional@example.com\nother@example.com",
          label: "Custom Recipients (one per line or comma-separated)" %>

      <p class="text-sm text-gray-500 dark:text-gray-400">
        Recipients will be built automatically when you save
      </p>
    </div>

    <hr class="border-gray-200 dark:border-gray-700">

    <%= f.submit communication.new_record? ? "Create Draft" : "Update Draft" %>
  <% end %>
</div>
