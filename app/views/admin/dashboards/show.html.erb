<% title Current.event.name %>

<%= render "section", title: "Health" do %>
  <%= render "stats", data: {
    "Tickets amount" => format_money(@orders.sum(&:amount)),
    "Sponsors amount" => format_money(Current.event.sponsorships.sum(:price_paid)),
    "Refunded amount" => format_money(@orders.sum(&:refunded_amount)),
    "Attendees" => @orders.reject(&:fully_refunded?).sum { it.tickets.size },
    "Newsletter subscribers" => Current.event.subscribers.count,
    "Unfinished orders" => Current.event.orders.where("completed_at IS NULL").count,
  } %>
<% end %>

<%= render "section", title: "Tickets", description: "Tickets from the last 10 orders" do %>
  <% if @orders.any? %>
    <%= render "admin/tickets/tickets", tickets: @orders.first(10).flat_map(&:tickets) %>
  <% else %>
    <%= render "empty_state" %>
  <% end %>
<% end %>

<%= render "section", title: "T-shirts", description: "T-shirt sizes for all attendees" do %>
  <% shirt_sizes = Current.event.tickets.group(:shirt_size).count %>
  <% if shirt_sizes.any? %>
    <% total_shirts = shirt_sizes.values.sum %>
    <% render "stats", columns: shirt_sizes.count, data: shirt_sizes.map {
      ["#{_1} (#{(_2.to_f / total_shirts * 100).round}%)", _2]
    } %>
  <% else %>
    <%= render "empty_state" %>
  <% end %>
<% end %>

<% if Current.event.embeddings.any? %>
  <%= render "section", title: "Embeddings", description: "Embedded resources for #{Current.event.name}" do %>
    <%= render "admin/embeddings/embeddings", embeddings: Current.event.embeddings %>
  <% end %>
<% else %>
  <%= render "section", title: "Embeddings" do %>
    <%= render "empty_state" do %>
      <% admin_button(:primary, link: new_admin_event_embedding_path(Current.event)) { "New embedding" } %>
    <% end %>
  <% end %>
<% end %>
